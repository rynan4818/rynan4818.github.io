<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beat Saber Version History Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        .description {
            background-color: #e9ecef;
            border-left: 5px solid #007bff;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
            color: #555;
            line-height: 1.6;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .description a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .description a:hover {
            text-decoration: underline;
        }
        .chart-container {
            background-color: #fff;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chart {
            width: 100%;
            height: 400px;
        }
        .loading {
            text-align: center;
            font-size: 1.2em;
            margin-top: 50px;
        }
    </style>
</head>
<body>

    <h1>Beat Saber プレイヤーバージョン分布</h1>

    <div class="description">
        らっきょさんの以下のページのhistory.jsonのデータを利用させて頂いています。<br>
        <a href="https://github.com/rakkyo150/player_count_by_bs_version" target="_blank">player_count_by_bs_version</a><br>
        毎週金曜日にデータ更新されているので、それに合わせてこのグラフも更新されます。<br>
        <br>
        steamとoculuspcはPC版としてカウント、<br>
        oculusはQuest版としてカウントしています。
    </div>

    <div id="loading" class="loading">データを取得中...</div>

    <div class="chart-container">
        <div id="chart1" class="chart"></div>
    </div>

    <div class="chart-container">
        <div id="chart2" class="chart"></div>
    </div>

    <div class="chart-container">
        <div id="chart3" class="chart"></div>
    </div>

    <div class="chart-container">
        <div id="chart4" class="chart"></div>
    </div>

    <script>
        const DATA_URL = 'https://raw.githubusercontent.com/rakkyo150/player_count_by_bs_version/refs/heads/master/data/history.json';
        const TARGET_VERSION = "1.29.1";

        // バージョン比較関数 (v1 > v2 なら 1, v1 < v2 なら -1, 等しければ 0)
        function compareVersions(v1, v2) {
            const p1 = v1.split('.').map(Number);
            const p2 = v2.split('.').map(Number);
            const len = Math.max(p1.length, p2.length);

            for (let i = 0; i < len; i++) {
                const num1 = p1[i] || 0;
                const num2 = p2[i] || 0;
                if (num1 > num2) return 1;
                if (num1 < num2) return -1;
            }
            return 0;
        }

        // 日付パース関数 (YYYYMMDD_HHmmss -> Date Object)
        function parseTimestamp(ts) {
            // 例: 20251017_130928
            const year = ts.substring(0, 4);
            const month = ts.substring(4, 6);
            const day = ts.substring(6, 8);
            const hour = ts.substring(9, 11);
            const min = ts.substring(11, 13);
            const sec = ts.substring(13, 15);
            return new Date(`${year}-${month}-${day}T${hour}:${min}:${sec}`);
        }

        async function fetchDataAndRender() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                const rawData = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                processAndRender(rawData);

            } catch (error) {
                document.getElementById('loading').textContent = 'データの読み込みに失敗しました: ' + error.message;
                console.error(error);
            }
        }

        function processAndRender(data) {
            // データの準備
            const timeSeries = [];
            
            // グラフ1, 2用 (PC集計)
            const pcAggregated = {
                legacy: [], // <= 1.29.1
                modern: []  // > 1.29.1
            };
            
            // グラフ3用 (PC詳細)
            const pcVersionsMap = {}; 
            // グラフ4用 (Quest詳細)
            const questVersionsMap = {};

            data.forEach(entry => {
                const date = parseTimestamp(entry.timestamp);
                const dateStr = date.toLocaleString('ja-JP'); // X軸表示用
                timeSeries.push(dateStr);

                let pcLegacyCount = 0;
                let pcModernCount = 0;

                // その時点での全バージョンキーを走査
                for (const [key, count] of Object.entries(entry.platform_game_version)) {
                    // key例: "steam,1.29.1" または "oculus,1.28.0"
                    const parts = key.split(',');
                    if (parts.length < 2) continue;

                    const platform = parts[0];
                    const version = parts[1];

                    if (!version) continue;

                    // PC版判定 (steam or oculuspc)
                    if (platform === 'steam' || platform === 'oculuspc') {
                        // 集計ロジック
                        if (compareVersions(version, TARGET_VERSION) <= 0) {
                            pcLegacyCount += count;
                        } else {
                            pcModernCount += count;
                        }
                    }
                }

                pcAggregated.legacy.push(pcLegacyCount);
                pcAggregated.modern.push(pcModernCount);
                
                // 詳細データの記録（後処理用に一時保存）
                entry._pcDetails = {};
                entry._questDetails = {};
                
                for (const [key, count] of Object.entries(entry.platform_game_version)) {
                    const parts = key.split(',');
                    const platform = parts[0];
                    const version = parts[1];
                    if (!version) continue;

                    if (platform === 'steam' || platform === 'oculuspc') {
                        if (!entry._pcDetails[version]) entry._pcDetails[version] = 0;
                        entry._pcDetails[version] += count;
                    } else if (platform === 'oculus') {
                        entry._questDetails[version] = count;
                    }
                }
            });

            // 詳細データの配列整形
            const allPcVers = new Set();
            const allQuestVers = new Set();
            data.forEach(d => {
                if(d._pcDetails) Object.keys(d._pcDetails).forEach(v => allPcVers.add(v));
                if(d._questDetails) Object.keys(d._questDetails).forEach(v => allQuestVers.add(v));
            });

            // バージョンごとに時系列配列を作成
            const pcSeries = [];
            Array.from(allPcVers).sort((a,b) => compareVersions(a,b)).forEach(ver => {
                const counts = data.map(d => (d._pcDetails && d._pcDetails[ver]) ? d._pcDetails[ver] : 0);
                pcSeries.push({ name: ver, type: 'line', data: counts, showSymbol: false });
            });

            const questSeries = [];
            Array.from(allQuestVers).sort((a,b) => compareVersions(a,b)).forEach(ver => {
                const counts = data.map(d => (d._questDetails && d._questDetails[ver]) ? d._questDetails[ver] : 0);
                questSeries.push({ name: ver, type: 'line', data: counts, showSymbol: false });
            });

            // -------------------------------------------------
            // グラフ1: PC版 1.29.1以下 vs それ以上 (人数)
            // -------------------------------------------------
            const chart1 = echarts.init(document.getElementById('chart1'));
            chart1.setOption({
                title: { text: `PC版: バージョン ${TARGET_VERSION} 以下 vs 以上 (プレイヤー数)`, left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: [`${TARGET_VERSION} 以下`, `${TARGET_VERSION} 超`], bottom: 0 },
                xAxis: { type: 'category', data: timeSeries },
                yAxis: { type: 'value', name: '人数' },
                series: [
                    { name: `${TARGET_VERSION} 以下`, type: 'line', data: pcAggregated.legacy, smooth: true },
                    { name: `${TARGET_VERSION} 超`, type: 'line', data: pcAggregated.modern, smooth: true }
                ]
            });

            // -------------------------------------------------
            // グラフ2: PC版 1.29.1以下 vs それ以上 (割合)
            // -------------------------------------------------
            const legacyRate = [];
            const modernRate = [];
            for(let i=0; i<timeSeries.length; i++) {
                const total = pcAggregated.legacy[i] + pcAggregated.modern[i];
                if (total === 0) {
                    legacyRate.push(0);
                    modernRate.push(0);
                } else {
                    legacyRate.push((pcAggregated.legacy[i] / total * 100).toFixed(1));
                    modernRate.push((pcAggregated.modern[i] / total * 100).toFixed(1));
                }
            }

            const chart2 = echarts.init(document.getElementById('chart2'));
            chart2.setOption({
                title: { text: `PC版: バージョン ${TARGET_VERSION} 以下 vs 以上 (割合)`, left: 'center' },
                tooltip: { trigger: 'axis', valueFormatter: (value) => value + '%' },
                legend: { data: [`${TARGET_VERSION} 以下`, `${TARGET_VERSION} 超`], bottom: 0 },
                xAxis: { type: 'category', data: timeSeries },
                yAxis: { type: 'value', name: '割合(%)', max: 100 },
                series: [
                    { name: `${TARGET_VERSION} 以下`, type: 'line', data: legacyRate, smooth: true, areaStyle: {} },
                    { name: `${TARGET_VERSION} 超`, type: 'line', data: modernRate, smooth: true, areaStyle: {} }
                ]
            });

            // -------------------------------------------------
            // グラフ3: PC版 バージョン別詳細
            // -------------------------------------------------
            const chart3 = echarts.init(document.getElementById('chart3'));
            chart3.setOption({
                title: { text: 'PC版: バージョン別推移 (詳細)', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { type: 'scroll', bottom: 0 },
                grid: { bottom: 80 },
                xAxis: { type: 'category', data: timeSeries },
                yAxis: { type: 'value', name: '人数' },
                series: pcSeries
            });

            // -------------------------------------------------
            // グラフ4: Quest版 バージョン別詳細
            // -------------------------------------------------
            const chart4 = echarts.init(document.getElementById('chart4'));
            chart4.setOption({
                title: { text: 'Quest版: バージョン別推移 (詳細)', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { type: 'scroll', bottom: 0 },
                grid: { bottom: 80 },
                xAxis: { type: 'category', data: timeSeries },
                yAxis: { type: 'value', name: '人数' },
                series: questSeries
            });

            window.addEventListener('resize', () => {
                chart1.resize();
                chart2.resize();
                chart3.resize();
                chart4.resize();
            });
        }

        fetchDataAndRender();
    </script>
</body>
</html>
